# 前后端分离的康复评估系统设计方案

## 1. 项目架构

### 1.1 技术栈

* **后端**: Python + FastAPI + WebSocket + Ultralytics YOLO
* **前端**: HTML5 + JavaScript + CSS + WebRTC + WebSocket + Canvas

### 1.2 架构图

```
┌─────────────┐      WebSocket      ┌─────────────┐
│   前端网页   │  ╭──────────────────▶  后端服务   │
│  (浏览器)    │  │  视频帧流        │  (FastAPI)  │
│  - 摄像头调用 │  │                  │  - YOLO姿态  │
│  - 动作选择面板│  │  识别结果        │    估计      │
│  - WebSocket │  │                  │  - 动作评估  │
│  - 可视化展示 │◀───────────────────╯  - 自定义动作 │
│  - 设置面板   │  │  配置更新        │    管理      │
│  - 视频保存功能│  │  动作选择        │  - 配置管理  │
└─────────────┘                     └─────────────┘
```

## 2. 后端设计

### 2.1 核心功能

* WebSocket服务，接收前端视频流和动作选择
* YOLO姿态估计模型集成
* 康复动作识别算法（针对选定动作）
* 自定义动作管理（添加、保存、加载）
* 实时结果返回

### 2.2 目录结构

```
backend/
├── app.py              # FastAPI应用入口
├── websocket.py        # WebSocket处理
├── models/
│   ├── rehab_evaluator.py  # 康复动作评估模块
│   └── action_config.py    # 动作配置管理
├── utils/
│   ├── image_processing.py  # 图像处理工具
│   └── config_manager.py    # 配置管理
└── data/
    └── action_configs.json  # 动作配置存储
```

### 2.3 关键接口

* **WebSocket**: `/ws` - 处理实时视频流、动作选择和识别结果
* **REST API**:
  * `GET /actions` - 获取所有动作配置
  * `POST /actions` - 添加/更新动作配置
  * `DELETE /actions/{action_id}` - 删除动作配置

## 3. 前端设计

### 3.1 核心功能

* 摄像头调用与视频预览
* 动作选择面板（用户手动选择动作）
* 视频帧捕获与编码
* WebSocket连接管理
* 实时可视化展示
  * 人体骨架绘制
  * 动作角度显示
  * 动作次数计数
  * 动作阶段指示
  * 当前选择的动作名称显示
* 设置功能
  * 置信度调整
  * 图像大小调整
  * 线条粗细调整
  * 自定义动作添加/编辑
* 评估视频保存

### 3.2 目录结构

```
frontend/
├── index.html          # 主页面
├── styles.css          # 样式文件
└── scripts/
    ├── main.js         # 主逻辑
    ├── webcam.js       # 摄像头处理
    ├── websocket.js    # WebSocket通信
    ├── visualization.js # 可视化展示
    ├── action_selector.js # 动作选择面板
    ├── settings.js     # 设置面板管理
    ├── custom_actions.js # 自定义动作管理
    └── video_saver.js  # 视频保存功能
```

### 3.3 界面设计

#### 主界面布局

```
┌───────────────────────────────────────────────────┐
│ 标题：康复动作评估系统                             │
├─────────────────┬─────────────────────────────────┤
│ 视频预览区域     │ 统计信息区域                     │
│                 │  - 当前选择动作：[下拉选择框]     │
│  (Canvas)       │  - 动作次数：XX次               │
│                 │  - 当前阶段：UP/DOWN            │
│                 │  - 动作角度：XX.X°              │
├─────────────────┼─────────────────────────────────┤
│ 设置面板按钮     │ 视频保存按钮                     │
│ 自定义动作按钮   │ 开始/停止评估按钮              │
└─────────────────┴─────────────────────────────────┘
```

#### 动作选择流程

1. 用户从下拉菜单中选择动作（内置动作 + 自定义动作）
2. 点击"开始评估"按钮
3. 系统开始对所选动作进行识别和计数
4. 点击"停止评估"按钮结束评估

#### 设置面板

```
┌───────────────────────────────────────────────────┐
│ 设置面板                                          │
├─────────────┬─────────────────────────────────────┤
│ 基本设置     │ 自定义动作管理                     │
│  - 置信度：[滑块] │ ┌─────────────────────────────┐│
│  - 图像大小：[下拉]│ │ 动作列表                  ││
│  - 线条粗细：[滑块] │ │ ───────────────────────── ││
│                 │ │ 内置动作：                  ││
│                 │ │  - 手臂上举                 ││
│                 │ │  - 二头肌弯举               ││
│                 │ │  - 肩部推举                 ││
│                 │ │  - 深蹲                     ││
│                 │ │  - 腿部上举                 ││
│                 │ │ 自定义动作：                ││
│                 │ │  - [用户添加的动作列表]     ││
│                 │ └─────────────────────────┘│
│                 │  [添加动作] [编辑动作] [删除动作] │
└─────────────────┴─────────────────────────────┘
```

### 3.4 可视化内容

* 实时视频流（带人体骨架）
* 用户选择的动作名称（大字体显示）
* 动作次数计数器
* 动作阶段指示器（UP/DOWN）
* 关键角度数值显示
* 彩色线条区分不同动作阶段

## 4. 集成现有功能

### 4.1 复用现有康复评估逻辑

* 集成`rehabilitation_evaluation.py`中的动作配置
* 复用AIGym类的姿态分析功能
* 适配WebSocket实时处理需求
* 扩展支持用户手动选择动作

### 4.2 支持的康复动作

* 内置动作：
  * 手臂上举
  * 二头肌弯举
  * 肩部推举
  * 深蹲
  * 腿部上举
* 用户自定义动作（添加后显示在动作列表中）

## 5. 部署方案

### 5.1 本地部署

1. 安装后端依赖：`pip install fastapi uvicorn websockets ultralytics opencv-python`
2. 启动后端服务：`uvicorn backend.app:app --host 0.0.0.0 --port 5000`
3. 在浏览器中打开 `frontend/index.html`

### 5.2 通信协议

* 使用WebSocket进行双向通信
* 视频帧使用Base64编码传输
* 消息格式：
  * 前端发送：
    ```json
    {
      "type": "video",
      "data": "base64编码的视频帧",
      "selected_action": "手臂上举"
    }
    ```
  * 后端返回：
    ```json
    {
      "type": "result",
      "action_name": "手臂上举",
      "angle": 120.5,
      "count": 5,
      "stage": "UP",
      "keypoints": [...],
      "status": "success"
    }
    ```

## 6. 开发计划

1. **后端开发**：
   * 搭建FastAPI应用
   * 实现WebSocket服务
   * 集成YOLO姿态估计模型
   * 实现康复动作评估算法
   * 添加动作配置管理API

2. **前端开发**：
   * 实现摄像头调用和视频预览
   * 开发动作选择面板
   * 实现WebSocket通信
   * 开发可视化展示功能
   * 添加设置面板
   * 实现自定义动作管理
   * 实现视频保存功能

3. **集成测试**：
   * 前后端联调
   * 功能测试
   * 性能优化
   * 不同动作的识别测试
   * 自定义动作功能测试

4. **本地部署测试**：
   * 完整流程测试
   * 用户体验测试
   * 视频保存功能测试